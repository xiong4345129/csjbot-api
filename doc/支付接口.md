####迎宾支付接口

更新记录：
  * v2: 2017-04-12 更新下单请求路径和格式；增加查询订单返回参数；增加关闭支付接口；
  * v1: 2017-04-06 修改返回消息格式
  * v0: 2017-03-30 初稿

---

接口定义：

1. **下单请求：设备 -> 后台**  
    协议：HTTP/1.1 POST  
    HOST：120.27.233.57:8080  
    路径：`/api/pay/wx/order` 即 /api/支付/微信/下单  
    消息头：
      * Content-Type: application/json （消息体统一为json格式）  
      * 自定义：校验用的key-value，时间戳等（可选项、暂不处理）    

    消息体（注意所有字段**均不可省**）：
    ```json
    {
      "id": "",
      "orderPseudoNo": "",
      "orderTime": "2017-02-24T10:51:41+08:00",
      "orderList": [
        {
          "itemId": "ZHY00001",
          "itemQty": 3
        },
        {
          "itemId": "ZHY00007",
          "itemQty": 1
        }
      ],
      "orderDesc":"",
      "payMethod":"NATIVE",
      "robotUid": "",
      "robotModel":"yingbin",
      "venderCode": "",
      "venderUser": ""  
    }
    ```
    * `id：<string>`
    该条http请求的**唯一ID**，仅可能用于去重、无实际含义，数字、英文字母或连字符组成的32位字串，建议用当前Unix时间(13位)+机器人uid(部分)+随机String组成
    * `orderPseudoNo：<string>`
    设备端自行生成的虚拟订单号，用于区别下单请求，数字、英文字母和连字符组成，规定用某一起始时间点+该时间点以来的下单编号组成，如某用户于2017/3/29 17:45登录了机器人（即开启了下单界面）、这是该用户登陆以来第12单，则构成`orderPseudoNo`为`201703291745-12`（第132单则为`-132`）
    * `orderTime：<string>`
    顾客确认下单时间（非请求发送时间）, ISO 8601格式，时区固定北京`+08:00`
    * `orderList: <array>`
    订单商品列表，不能为空`[]`
    * `orderList[].itemId: <string>`
    商品ID、后台数据库事先定义
    * `orderList[].itemQty: <number>`
    商品购买数量、正整数
    * ~~`orderList[].state: <string>`
    商品购买状态，目前写死`REGULAR`（表示常规商品、使用数据库标准单价）~~
    * `orderDesc：<string>`
    订单简洁信息描述，参考[微信开发文档-body字段格式要求
](https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=4_2)，如“周黑鸭xx店-食品”  
    * `payMethod: <string>`
    支付方法，目前微信只支持扫码支付`NATIVE`
    * `robotUid: <string>`
    机器人设备的**唯一ID**
    * `robotModel: <string>`
    机器人型号，迎宾机器人写死`yingbin`
    * `venderCode: <string>`
    商户代码、后台数据库事先定义，如周黑鸭`ZHY`
    * `venderUser: <string>`
    商户管理者ID、即当前机器人登陆用户的账号


2. **下单返回：后台 -> 设备**  
    说明：后台收到设备端下单申请后需向支付宝或微信提交支付请求、等收到三方结果后再返给设备、可能延时较久。  
    返回状态：成功`200`，失败或出错返回相应`3xx`、`4xx`、`5xx` status code  
    消息体：
    ```json
    {
      "id":"",
      "orderStatus":"",
      "orderPseudoNo": "",
      "orderId": "",
      "codeUrl":"",
      "errCode":"",
      "errDesc":"",
      "remark":""
    }
    ```
    * `id：<string>`
    返回设备请求下单时http request的消息ID，非严格情况可能省略
    * `orderStatus：<string>`
    下单请求结果，只可能为成功`SUCCESS`或失败`FAIL`，必填
    * `orderPseudoNo：<string>`
    返回设备请求中上传的虚拟订单号、必填
    * `orderId：<string>`
    后台生成的正式订单流水号、全局唯一、成功时必填
    * `codeUrl：<string>`
    扫码支付时用于生成二维码的链接，成功时必填
    * `errCode：<string>`
    错误代码、可能来自三方或后台自定义，失败时必填
    * `errDesc: <string>`
    错误说明、可能来自三方或后台自定义，失败时必填
    * `remark: <string>`
    备注说明，可能省略  


3. **查询订单状态：设备 -> 后台**    
    协议：HTTP/1.1 GET  
    HOST：120.27.233.57:8080  
    路径：`/api/pay/wx/query`    
    请求参数：`orderid` 后台生成的订单流水号   
    示例：查询订单1490947-9115-000-001-661的支付状态   
    请求url：
    ```
    https://120.27.233.57:8080/api/pay/wx/query?orderid=1490947-9115-000-001-661
    ```
    返回状态：成功`200`，失败或出错返回相应`3xx`、`4xx`、`5xx` status code  
    返回结果：
    ```json
    {
      "orderId":"1490947-9115-000-001-661",
      "orderTime":"",
      "closeTime":"",
      "orderTotalFee":,
      "orderStatus":"",
      "payStatus":"",
      "payTimeStart":"",
      "payTimeExpire":"",
      "payTimeEnd":"",
      "payCashFee":,
      "payCouponFee":,
      "payRefundFee":,
      "wxOpenId":"",
      "wxTransactionId":"",
      "remark":""
    }
    ```
    * `orderId：<string>`
    后台生成的正式订单流水号  
    * `orderTime：<string>`
    顾客下单时间
    * `closeTime：<string>`
    后台订单关闭时间（状态可能为成功或失败）
    * `orderTotalFee: <number>`
    订单标价总金额
    * `orderStatus：<string>`
    下单状态。可能值：下单成功`SUCCESS`、下单失败`FAIL`  
    * `payStatus：<string>`
    支付状态。可能值：等待支付`WAIT`、支付完成`SUCCESS`、支付失败`FAIL`、支付取消`CANCEL`、支付关闭`CLOSE`、支付超时/失效`EXPIRE`      
    * `payTimeStart：<string>`
    支付发起，必填
    * `payTimeExpire：<string>`
    支付失效时间，后台设置
    * `payTimeEnd：<string>`
    支付确认时间，支付成功时必填    
    * `payCashFee: <number>`
    实际现金支付金额（目前应等于标价总金额）
    * `payCouponFee: <number>`
    实际代金券支付金额
    * `payRefundFee: <number>`
    实际退款金额
    * `wxOpenId: <string>`
    支付者的微信openid
    * `wxTransactionId: <string>`
    微信支付交易单号、与用户收到的支付凭证中一致
    * `remark: <string>`
    备注说明，可能省略    

    （**暂定**）orderStatus和payStatus的区别：  
    以扫码支付为例，orderStatus主要反映设备提交下单申请到后台获取到微信的二维码链接间的下单状态，payStatus则主要反映已获取到二维码链接之后的订单支付状态。示例表（因为具体出错处理可能还要再改，请以是否等于`SUCCESS`判断成功失败）：  
    |  操作1  |  orderStatus  |  操作2  |  payStatus  |  code_url  |
    |-------------|---------------|-------------|-------------|------------|
    |设备->后台 下单检查失败  |  不记录  ||  不记录  |无|
    |设备->后台 下单检查ok |  ACCEPT  ||  PRE  |无|
    |后台->微信 下单失败/出错 |  FAIL ||  CANCEL |无|
    |后台->微信 下单成功 |SUCCESS|微信->后台 获取链接成功 等待用户支付|  WAIT |未使用/有效|
    |后台->微信 下单成功 |SUCCESS|用户支付成功 微信->后台 异步通知| SUCCESS |已使用/失效|
    |后台->微信 下单成功 |SUCCESS|用户未支付 未超时 设备->后台 主动关闭订单| CLOSE |关闭/失效|
    |后台->微信 下单成功 |SUCCESS|用户未支付 已超时 后台->微信 主动查询订单| EXPIRE |超时/失效|
    |后台->微信 下单成功 |SUCCESS|其他出错| FAIL |待确认|



4. **关闭订单：设备 -> 后台**    
    协议：HTTP/1.1 POST  
    HOST：120.27.233.57:8080  
    路径：`/api/pay/wx/close`    
    消息体：  
    ```json
    {
      "id": "",
      "orderId": "",
      "robotUid": "",
      "robotModel":"yingbin"
    }
    ```
5. **关闭订单返回：后台 -> 设备**    
    说明：微信订单最快**5分钟**后才能关闭，参考[关闭订单](https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_3)   
    返回消息：  
    ```json
    {
      "id": "",
      "orderId": "",
      "orderStatus":"",
      "payStatus":"CLOSE",
      "errCode":"",
      "errDesc":"",
      "remark":""
    }
    ```
    * 关闭请求成功时，返回http status code `200`，orderStatus为实际状态（理论上只应该是`SUCCESS`），payStatus为`CLOSE`，errCode、errDesc、remark均为空;
    * 关闭请求失败或出错时，返回相应`3xx`、`4xx`、`5xx` status code，errCode或remark至少一项不为空，orderStatus和payStatus为空或为实际情况；
